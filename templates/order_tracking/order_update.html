{% extends "base/_base_in_product.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    Update Order
{% endblock title %}

{% block content %}
    <div>
        <form method="post" enctype="multipart/form-data">
            <div>
                {% csrf_token %}
                {% crispy form %}
            </div>
            <button type="submit" class="btn btn-primary">Update</button>
            <button type="button" id="add-note-button" class="btn btn-primary custom-add-note-button">Add Note</button>
            <div class="col-md-4">
                <div class="order-notes text-center">
                    <label>Notes Log</label>
                    <ul class="order-note-list">
                        {% for note in notes %}
                            <li>
                                <div class="note-content">{{ note.content }}</div>
                                <div class="note-timestamp">{{ note.timestamp }}</div>
                                <button class="note_delete" data-note-id="{{ note.id }}" data-delete-url="{% url 'order_tracking:note_delete' note.id %}">X</button>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Function to get the CSRF token
                    function getCSRFToken() {
                        const csrfTokenElement = document.getElementsByName('csrfmiddlewaretoken')[0];
                        return csrfTokenElement ? csrfTokenElement.value : null;
                    }

                    // Add an event listener for the "Add Note" button
                    document.getElementById('add-note-button').addEventListener('click', function () {
                        const noteContent = document.getElementById('id_content').value.trim();

                        if (noteContent !== '') {
                            const formData = new FormData();
                            formData.append('content', noteContent);

                            fetch('{% url "order_tracking:note_update" pk=object.pk %}', {
                                method: "POST",
                                body: formData,
                                headers: {
                                    "X-CSRFToken": getCSRFToken(),
                                    "X-Note-Action": "create",
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Construct the new note element and add it to the list
                                    const noteElement = document.createElement('li');
                                    noteElement.innerHTML = `
                                        <div class="note-content">${noteContent}</div>
                                        <div class="note-timestamp">${data.timestamp}</div>
                                        <button class="note-delete" data-note-id="${data.note_id}">X</button>
                                    `;

                                    const noteList = document.querySelector('.order-note-list');
                                    noteList.appendChild(noteElement);

                                    // Clear the note content input field
                                    document.getElementById('id_content').value = '';
                                } else {
                                    console.error("Error adding note:", data.error);
                                }
                            })
                            .catch(error => {
                                console.error("Error adding note:", error);
                            });
                        }
                    });

                    // Add an event listener for the "X" buttons using event delegation
                    document.addEventListener('click', function (event) {
                        if (event.target.classList.contains('note-delete')) {
                            event.preventDefault(); // Prevent the default form submission behavior

                            const noteId = event.target.getAttribute('data-note-id');

                            fetch('{% url "order_tracking:note_delete" 0 %}'.replace('0', noteId), {
                                method: "POST",
                                headers: {
                                    "X-CSRFToken": getCSRFToken()
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Remove the deleted note element from the list
                                    event.target.closest('li').remove();
                                } else {
                                    console.error("Error deleting note:", data.error);
                                }
                            })
                            .catch(error => {
                                console.error("Error deleting note:", error);
                            });
                        }
                    });
                });
            </script>

            <style>
                .order-notes {
                    background-color: #f8f9fa;
                    border: 1px solid #dcdcdc;
                    padding: 10px 20px 10px 10px;
                }

                .order-note-list {
                    list-style: none;
                    padding: 0;
                }

                .order-note-list li {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 10px;
                    border-bottom: 1px solid #dcdcdc;
                    padding-bottom: 10px;
                }

                .note-content {
                    text-align: left;
                    width: 50%;
                    word-wrap: break-word;
                }

                 .note-timestamp {
                     text-align: right;
                     padding-right: 10px;
                     width: 50%;
                     text-align: right;
                }



                .custom-add-note-button {
                    background-color: #007bff; /* Change the button's background color */
                    color: #fff; /* Change the text color to white */
                    border: none; /* Remove the default button border */
                    border-radius: 5px; /* Add rounded corners */
                    padding: 10px 20px; /* Adjust padding for better button sizing */
                    cursor: pointer; /* Add a pointer cursor on hover */
                }

                .custom-add-note-button:hover {
                    background-color: #0056b3; /* Change the background color on hover */
                }



                .note-delete {
                    color: red; /* Make the "X" text red */
                    width: 30px; /* Set a fixed width for the "X" button */
                    height: 30px; /* Set a fixed height for the "X" button */
                    text-align: center; /* Center the "X" horizontally within the button */
                    cursor: pointer; /* Add a pointer cursor on hover */
                }

                /* Add this CSS code if you want to change the button's background color on hover */
                .note-delete:hover {
                    background-color: lightcoral; /* Change the background color on hover */
                }
            </style>
        </form>
    </div>
{% endblock content %}
